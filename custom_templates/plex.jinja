{% macro create_plex_session_sensor(unique_id, session_index) %}
sensor:
  - unique_id: {{ unique_id }}
    name: Plex Session {{ session_index }} (Tautulli)
    icon: mdi:plex
    state: >
      {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
      {% if sessions is not none and sessions | length >= session_index %}
        {{ sessions[session_index - 1].state | default('off') }}
      {% else %}
        off
      {% endif %}
    attributes:
      user: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].user | default('Unknown') }}
        {% else %}
          Unknown
        {% endif %}
      progress_percent: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].progress_percent | default(0) }}
        {% else %}
          0
        {% endif %}
      media_type: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].media_type | default('Unknown') }}
        {% else %}
          Unknown
        {% endif %}
      full_title: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].full_title | default('Unknown') }}
        {% else %}
          Unknown
        {% endif %}
      grandparent_thumb: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].grandparent_thumb | default('') }}
        {% else %}
          ''
        {% endif %}
      thumb: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].thumb | default('') }}
        {% else %}
          ''
        {% endif %}
      parent_media_index: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].parent_media_index | default(0) }}
        {% else %}
          0
        {% endif %}
      media_index: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].media_index | default(0) }}
        {% else %}
          0
        {% endif %}
      year: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].year | default('Unknown') }}
        {% else %}
          Unknown
        {% endif %}
      product: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].product | default('Unknown') }}
        {% else %}
          Unknown
        {% endif %}
      player: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].player | default('Unknown') }}
        {% else %}
          Unknown
        {% endif %}
      device: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].device | default('Unknown') }}
        {% else %}
          Unknown
        {% endif %}
      platform: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].platform | default('Unknown') }}
        {% else %}
          Unknown
        {% endif %}
      location: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].location | default('Unknown') }}
        {% else %}
          Unknown
        {% endif %}
      ip_address: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].ip_address | default('Unknown') }}
        {% else %}
          Unknown
        {% endif %}
      ip_address_public: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].ip_address_public | default('Unknown') }}
        {% else %}
          Unknown
        {% endif %}
      local: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].local | default(false) }}
        {% else %}
          false
        {% endif %}
      relayed: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].relayed | default(false) }}
        {% else %}
          false
        {% endif %}
      bandwidth: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].bandwidth | default(0) }}
        {% else %}
          0
        {% endif %}
      video_resolution: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].video_resolution | default('Unknown') }}
        {% else %}
          Unknown
        {% endif %}
      stream_video_resolution: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].stream_video_resolution | default('Unknown') }}
        {% else %}
          Unknown
        {% endif %}
      transcode_decision: >
        {% set sessions = state_attr('sensor.tautulli_activity', 'sessions') %}
        {% if sessions is not none and sessions | length >= session_index %}
          {{ sessions[session_index - 1].transcode_decision | default('Unknown') }}
        {% else %}
          Unknown
        {% endif %}
{% endmacro %}
